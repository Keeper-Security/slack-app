
services:
  commander:
    container_name: keeper-service
    ports:
      - port:port
    image: keeper/commander:latest
    command: service-create -p 8900 -c 'search, share-record, share-folder, record-add, one-time-share, pedm, device-approve, get' -f json -q y -ur J_ZQJg4sMBsF0GYsuCtDHA --ksm-config XXXXXXXX --record XXXXXXXX
    healthcheck:
      test:
        - CMD-SHELL
        - python -c "import sys, urllib.request; sys.exit(0 if urllib.request.urlopen('http://localhost:port/health', timeout=2).status == 200 else 1)"
      interval: 60s
      timeout: 3s
      start_period: 10s
      retries: 30
    restart: unless-stopped

  slack-app:
    container_name: keeper-slack-app
    build:
      context: .
      dockerfile: Dockerfile
    image: keeper/slack-app:latest
    environment:
      # KSM Configuration - Base64 encoded KSM config
      - KSM_CONFIG=YOURKSMTOKENHERE
      # KSM Record Titles (fixed titles)
      - COMMANDER_RECORD=COMMADERSERVICEMODECONFIG
      - SLACK_RECORD=COMMADERSERVICEMODESLACKCONFIG
    depends_on:
      commander:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - ./logs:/app/logs
    # For connecting to Keeper Commander service
    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

